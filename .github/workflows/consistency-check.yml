---
name: Post-Merge Consistency Check

on:
  push:
    paths-ignore:
      - "docs/**"
      - "*.md"
      - "LICENSE"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

env:
  CARGO_INCREMENTAL: 0
  CARGO_TERM_COLOR: always
  CARGO_PROFILE_DEV_DEBUG: 1
  CARGO_PROFILE_TEST_DEBUG: 1

jobs:
  consistency-check:
    name: ğŸ” Consistency Check
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        crate:
          - "client/cli"
          - "client/consensus/qpow"
          - "client/network"
          - "miner-api"
          - "pallets/balances"
          - "pallets/merkle-airdrop"
          - "pallets/mining-rewards"
          - "pallets/qpow"
          - "pallets/reversible-transfers"
          - "pallets/scheduler"
          - "pallets/wormhole"
          - "primitives/consensus/qpow"
          - "primitives/dilithium-crypto"
          - "primitives/scheduler"
          - "primitives/state-machine"
          - "primitives/trie"
          - "primitives/wormhole"
          - "qpow-math"
    steps:
      - uses: actions/checkout@v4
      - uses: ./.github/actions/ubuntu
      - name: Install required components
        run: |
          rustup component add rustfmt --toolchain nightly
          rustup component add clippy rust-src
          cargo install taplo-cli --locked
      
      - name: Get crate name
        id: crate-info
        run: |
          cd ${{ matrix.crate }}
          CRATE_NAME=$(grep '^name = ' Cargo.toml | head -1 | sed 's/name = "\(.*\)"/\1/')
          echo "name=$CRATE_NAME" >> $GITHUB_OUTPUT
          echo "path=${{ matrix.crate }}" >> $GITHUB_OUTPUT
      
      - name: Format check
        run: |
          echo "ğŸ¨ Checking format for ${{ steps.crate-info.outputs.name }} in ${{ steps.crate-info.outputs.path }}"
          cd ${{ matrix.crate }}
          cargo +nightly fmt -- --check
      
      - name: Clippy check
        run: |
          echo "ğŸ“ Running clippy for ${{ steps.crate-info.outputs.name }}"
          cd ${{ matrix.crate }}
          SKIP_WASM_BUILD=1 cargo clippy --locked --all-targets --all-features -- -D warnings
      
      - name: Documentation check
        run: |
          echo "ğŸ“š Building documentation for ${{ steps.crate-info.outputs.name }}"
          cd ${{ matrix.crate }}
          SKIP_WASM_BUILD=1 cargo doc --locked --no-deps --all-features
      
      - name: Build check
        run: |
          echo "ğŸ”¨ Building ${{ steps.crate-info.outputs.name }}"
          cargo build --locked --release --package ${{ steps.crate-info.outputs.name }}
      
      - name: Test check
        run: |
          echo "ğŸ§ª Testing ${{ steps.crate-info.outputs.name }}"
          cd ${{ matrix.crate }}
          SKIP_WASM_BUILD=1 cargo test --locked --all-features
        continue-on-error: true  # Some crates might not have tests or might have test issues

  summary:
    name: ğŸ“‹ Consistency Check Summary
    runs-on: ubuntu-latest
    needs: consistency-check
    if: always()
    steps:
      - name: Check results
        run: |
          echo "Consistency check completed for all crates"
          if [[ "${{ needs.consistency-check.result }}" == "failure" ]]; then
            echo "âŒ Some consistency checks failed"
            exit 1
          else
            echo "âœ… All consistency checks passed"
          fi
